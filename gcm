from google.cloud import monitoring_v3


def run_query2(mql_query, project_id):
    client = monitoring_v3.QueryServiceClient()
    project_name = f"projects/{project_id}"
    list = []
    try:
        request = monitoring_v3.QueryTimeSeriesRequest(name=project_name, query=mql_query)
        response = client.query_time_series(request=request)
        for point in response.time_series_data:
            for entry in point.point_data:
                for val in entry.values:
                    list.append(val.double_value)
    except Exception as e:
        print(f"Error querying Monitoring API for project {project_id}: {e}")
    return list

if __name__ == "__main__":
    mql_query="fetch pubsub_subscription | metric 'pubsub.googleapis.com/subscription/ack_message_count' | filter resource.project_id == 'fkp-specter-pubsub' && (resource.subscription_id == 'in-hyderabad-1.dart.fkint.ixp.catalog.ProductStateEntity--M3DataProductAttributesProd--sub') | align rate(1m) | every 1m | group_by [metric.delivery_type], [value_ack_message_count_aggregate: aggregate(value.ack_message_count)] | within d'2025/07/23-11:34:39', d'2025/08/23-12:04:39'"
    print(run_query2(mql_query,'fkp-specter-pubsub'))
